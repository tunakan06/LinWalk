name: Create Title Pattern Background PR
on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create/Update C# file in branch
        uses: peter-evans/create-or-update-file@v4
        with:
          branch: add-title-pattern-bg
          file_path: Assets/Editor/TitleScreenSetup.cs
          commit_message: Add Editor tool script for title background
          content: |
            #if UNITY_EDITOR
            using UnityEngine;
            using UnityEditor;
            using UnityEditor.SceneManagement;
            using UnityEngine.SceneManagement;
            using UnityEngine.UI;

            /// <summary>
            /// Adds a patterned RawImage background (ProceduralStripedBG) to the active scene's Canvas.
            /// Menu: Tools / Title Screen / Add Pattern Background
            /// </summary>
            public static class TitleScreenSetup
            {
                [MenuItem("Tools/Title Screen/Add Pattern Background")]
                public static void AddPatternBackground()
                {
                    var activeScene = SceneManager.GetActiveScene();
                    if (!activeScene.isLoaded)
                    {
                        EditorUtility.DisplayDialog("No Scene Open",
                            "Please open the title scene you want to modify and run this command again.",
                            "OK");
                        return;
                    }

                    // Find or create Canvas
                    Canvas canvas = Object.FindObjectOfType<Canvas>();
                    GameObject canvasGO;
                    if (canvas == null)
                    {
                        canvasGO = new GameObject("Canvas", typeof(Canvas), typeof(CanvasScaler), typeof(GraphicRaycaster));
                        canvas = canvasGO.GetComponent<Canvas>();
                        canvas.renderMode = RenderMode.ScreenSpaceOverlay;

                        var cs = canvasGO.GetComponent<CanvasScaler>();
                        cs.uiScaleMode = CanvasScaler.ScaleMode.ScaleWithScreenSize;
                        cs.referenceResolution = new Vector2(1920, 1080);
                    }
                    else
                    {
                        canvasGO = canvas.gameObject;
                    }

                    // If background exists, offer overwrite
                    var existing = canvasGO.transform.Find("TitlePattern_Background");
                    if (existing != null)
                    {
                        if (!EditorUtility.DisplayDialog("Background Exists",
                            "A 'TitlePattern_Background' object already exists. Overwrite it?",
                            "Overwrite", "Cancel"))
                        {
                            return;
                        }
                        Object.DestroyImmediate(existing.gameObject);
                    }

                    // Create background RawImage
                    var bg = new GameObject("TitlePattern_Background", typeof(RawImage));
                    bg.transform.SetParent(canvasGO.transform, false);

                    var rt = bg.GetComponent<RectTransform>();
                    rt.anchorMin = Vector2.zero;
                    rt.anchorMax = Vector2.one;
                    rt.anchoredPosition = Vector2.zero;
                    rt.sizeDelta = Vector2.zero;

                    var raw = bg.GetComponent<RawImage>();
                    raw.raycastTarget = false;

                    // Place behind other UI
                    bg.transform.SetAsFirstSibling();

                    // Add ProceduralStripedBG and set defaults
                    var comp = bg.AddComponent<ProceduralStripedBG>();
                    comp.tileSize = 64;
                    comp.widthTiles = 8;
                    comp.heightTiles = 6;
                    comp.colorA = new Color(1f, 1f, 1f, 0.08f);
                    comp.colorB = new Color(0f, 0f, 0f, 0f);
                    comp.scrollSpeed = 0.5f;
                    comp.diagonalStripes = true;

                    // Mark scene dirty and save
                    EditorSceneManager.MarkSceneDirty(activeScene);
                    EditorSceneManager.SaveScene(activeScene);

                    EditorUtility.DisplayDialog("Done", "Title pattern background added and scene saved.", "OK");
                    Debug.Log("[TitleScreenSetup] Added TitlePattern_Background to scene: " + activeScene.name);
                }
            }
            #endif

      - name: Create/Update README file in branch
        uses: peter-evans/create-or-update-file@v4
        with:
          branch: add-title-pattern-bg
          file_path: Assets/TitleBackground_README.md
          commit_message: Add README for title background utility
          content: |
            # Title Pattern Background — Usage

            This project includes a small editor utility that adds a subtle, scrollable patterned background to a Canvas in your title scene.

            How to run
            1. Open the scene you want to modify (the title screen) in Unity Editor.
            2. From the top menu choose: Tools → Title Screen → Add Pattern Background
               - If no Canvas exists one will be created.
               - A GameObject named `TitlePattern_Background` (RawImage + ProceduralStripedBG) will be added as the first child of the Canvas.
               - The scene will be marked dirty and saved automatically.

            Tweak appearance
            - Select the `TitlePattern_Background` GameObject in the Hierarchy.
            - Inspect the `ProceduralStripedBG` component and adjust:
              - `tileSize`, `widthTiles`, `heightTiles` — pattern density
              - `colorA` (alpha controls subtlety) and `colorB`
              - `scrollSpeed` — how fast the pattern moves
              - `diagonalStripes` — toggle diagonal/vertical stripes

            Notes
            - The RawImage created has `raycastTarget = false` so it won't block UI interactions.
            - This tool modifies the currently open scene in the Editor — it does not change build settings.

      - name: Create pull request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: add-title-pattern-bg
          title: Add Editor tool to insert patterned RawImage background into title scene
          body: |
            概要
            タイトル画面を控えめに装飾するための Unity Editor メニューを追加します。メニュー実行により、開いているシーンの Canvas に対してフルスクリーンの RawImage（ProceduralStripedBG コンポーネント付き）を挿入できます。
